<!DOCTYPE html>
<html lang="en">
<head>
  <title>CLC Microservices Demo</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>ðŸ“¦ Microservices Control Center</h1>

  <div class="card">
    <h2>1. Product Catalog (Master Data)</h2>
    <p><small>Defines which products are known to the system.</small></p>

    <div class="form-row">
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="prodName" placeholder="e.g. iPhone 15">
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="prodDesc" placeholder="e.g. Smartphone">
      </div>
      <button class="btn-primary" onclick="createProduct()">Create</button>
    </div>

    <div id="prodStatus" class="status"></div>
  </div>

  <div class="card">
    <h2>2. Place Order (Order Service)</h2>
    <p><small>Select a known product and submit an order.</small></p>

    <div class="form-group">
      <label>Select product (live from metadata):</label>
      <select id="orderSelect">
        <option value="">Loading products...</option>
      </select>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Quantity:</label>
        <input type="number" id="orderAmount" value="1" min="1">
      </div>
      <button class="btn-order" onclick="placeOrder()">Place Order ðŸ›’</button>
    </div>

    <div id="orderStatus" class="status"></div>
  </div>

  <div class="card">
    <h2>3. Storage System (Inventory Service)</h2>
    <button class="btn-refresh" onclick="loadInventory()">ðŸ”„ Refresh</button>
    <p><small>Shows the current inventory state.</small></p>

    <table>
      <thead>
      <tr>
        <th>Product Name</th>
        <th>ID (UUID)</th>
        <th>Quantity</th>
        <th>Action</th>
      </tr>
      </thead>
      <tbody id="inventoryTable">
      <tr>
        <td colspan="4">Loading data...</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Small cache to map product IDs to names
  let productMap = {};

  // Initial load
  document.addEventListener("DOMContentLoaded", () => {
    loadProducts();
  });

  // --- 1. MASTER DATA SERVICE ---
  async function loadProducts() {
    const select = document.getElementById('orderSelect');

    try {
      const res = await fetch('/products');
      if (!res.ok) throw new Error("Could not load products");

      const products = await res.json();

      select.innerHTML = '<option value="">-- Please select --</option>';
      productMap = {};

      products.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.text = `${p.name} (${p.description})`;
        select.appendChild(opt);

        productMap[p.id] = p.name;
      });

      loadInventory();

    } catch (e) {
      console.error(e);
      select.innerHTML = '<option>Error: service unavailable</option>';
    }
  }

  async function createProduct() {
    const name = document.getElementById('prodName').value;
    const desc = document.getElementById('prodDesc').value;
    const status = document.getElementById('prodStatus');

    if (!name) {
      alert("Name is required!");
      return;
    }

    try {
      const res = await fetch('/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, description: desc })
      });

      if (res.ok) {
        status.innerHTML = '<span class="text-success">âœ” Product created!</span>';
        document.getElementById('prodName').value = '';
        loadProducts();
      } else {
        status.innerHTML = '<span class="text-error">Error while saving.</span>';
      }

    } catch (e) {
      status.innerHTML = '<span class="text-error">Service not reachable.</span>';
    }
  }

  // --- 2. ORDER SERVICE ---
  async function placeOrder() {
    const prodId = document.getElementById('orderSelect').value;
    const qty = document.getElementById('orderAmount').value;
    const status = document.getElementById('orderStatus');

    if (!prodId) {
      alert("Please select a product!");
      return;
    }

    try {
      const res = await fetch('/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId: prodId, quantity: parseInt(qty) })
      });

      if (res.ok) {
        status.innerHTML = '<span class="text-success">âœ” Order sent!</span>';
        setTimeout(loadInventory, 500);
      } else {
        status.innerHTML = '<span class="text-error">Order failed.</span>';
      }

    } catch (e) {
      status.innerHTML = '<span class="text-error">Order service offline?</span>';
    }
  }

  // --- 3. INVENTORY SERVICE ---
  async function loadInventory() {
    const tbody = document.getElementById('inventoryTable');

    try {
      const res = await fetch('/inventory');
      const items = await res.json();

      tbody.innerHTML = '';

      if (items.length === 0) {
        tbody.innerHTML =
                '<tr><td colspan="4" style="text-align:center">Inventory is empty.</td></tr>';
        return;
      }

      items.forEach(item => {
        const productName = productMap[item.productId] || "Unknown product";

        tbody.innerHTML += `
          <tr>
            <td><strong>${productName}</strong></td>
            <td><small style="color:#999">${item.productId}</small></td>
            <td>${item.quantity} units</td>
            <td>
              <button class="btn-delete" onclick="deleteItem('${item.productId}')">
                Delete
              </button>
            </td>
          </tr>
        `;
      });

    } catch (e) {
      tbody.innerHTML =
              '<tr><td colspan="4" class="text-error">Error: Could not load inventory.</td></tr>';
    }
  }

  async function deleteItem(id) {
    if (!confirm("Really delete this item?")) return;

    try {
      await fetch(`/inventory/${id}`, { method: 'DELETE' });
      loadInventory();
    } catch (e) {
      alert("Delete failed");
    }
  }
</script>

</body>
</html>
